datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

// BetterAuth models
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  emailVerified Boolean  @default(false)
  name          String?
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions    Session[]
  accounts    Account[]
  memberships OrgMember[]

  @@map("user")
}

model Organization {
  id                   String    @id @default(cuid())
  name                 String
  slug                 String    @unique
  plan                 String    @default("free")
  stripeCustomerId     String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  trialEndsAt          DateTime? @map("trial_ends_at")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  members     OrgMember[]
  projects    Project[]
  invitations Invitation[]

  @@map("organizations")
}

model OrgMember {
  id        String   @id @default(cuid())
  role      String   @default("member")
  userId    String   @map("user_id")
  orgId     String   @map("org_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@index([userId])
  @@index([orgId])
  @@map("org_members")
}

model Invitation {
  id         String    @id @default(cuid())
  email      String
  orgId      String    @map("org_id")
  role       String    @default("member")
  token      String    @unique
  expiresAt  DateTime  @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([email])
  @@map("invitations")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// Haspulse models
model Project {
  id        String   @id @default(dbgenerated("nanoid(16)"))
  orgId     String   @map("org_id")
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  org      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  checks   Check[]
  channels Channel[]
  apiKeys  ApiKey[]

  @@index([orgId])
  @@map("projects")
}

model Check {
  id                    String             @id @default(dbgenerated("nanoid(16)"))
  projectId             String             @map("project_id")
  name                  String
  slug                  String?
  scheduleType          ScheduleType       @map("schedule_type")
  scheduleValue         String             @map("schedule_value")
  graceSeconds          Int                @default(300) @map("grace_seconds")
  status                CheckStatus        @default(NEW)
  lastPingAt            DateTime?          @map("last_ping_at")
  lastStartedAt         DateTime?          @map("last_started_at")
  nextExpectedAt        DateTime?          @map("next_expected_at")
  lastAlertAt           DateTime?          @map("last_alert_at")
  alertOnRecovery       Boolean            @default(true) @map("alert_on_recovery")
  reminderIntervalHours Int?               @map("reminder_interval_hours")
  anomalySensitivity    AnomalySensitivity @default(NORMAL) @map("anomaly_sensitivity")
  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")

  project       Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  pings         Ping[]
  checkChannels CheckChannel[]
  alerts        Alert[]
  dailyStats    CheckDailyStat[]
  durationStats CheckDurationStat[]

  @@unique([projectId, slug])
  @@index([status])
  @@index([nextExpectedAt])
  @@map("checks")
}

model Ping {
  id          String   @id @default(dbgenerated("nanoid(16)"))
  checkId     String   @map("check_id")
  type        PingType
  body        String?
  sourceIp    String   @map("source_ip")
  durationMs  Int?     @map("duration_ms")
  startPingId String?  @map("start_ping_id")
  createdAt   DateTime @default(now()) @map("created_at")

  check Check @relation(fields: [checkId], references: [id], onDelete: Cascade)

  @@index([checkId, createdAt(sort: Desc)])
  @@map("pings")
}

model CheckDailyStat {
  id          String   @id @default(dbgenerated("nanoid(16)"))
  checkId     String   @map("check_id")
  date        DateTime @db.Date
  upMinutes   Int      @default(0) @map("up_minutes")
  downMinutes Int      @default(0) @map("down_minutes")
  totalPings  Int      @default(0) @map("total_pings")
  upPercent   Float    @default(0) @map("up_percent")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  check Check @relation(fields: [checkId], references: [id], onDelete: Cascade)

  @@unique([checkId, date])
  @@index([checkId, date])
  @@map("check_daily_stats")
}

model CheckDurationStat {
  id            String   @id @default(dbgenerated("nanoid(16)"))
  checkId       String   @map("check_id")
  windowStart   DateTime @map("window_start")
  windowEnd     DateTime @map("window_end")
  sampleCount   Int      @default(0) @map("sample_count")
  avgDurationMs Float?   @map("avg_duration_ms")
  p50DurationMs Int?     @map("p50_duration_ms")
  p95DurationMs Int?     @map("p95_duration_ms")
  p99DurationMs Int?     @map("p99_duration_ms")
  stdDevMs      Float?   @map("std_dev_ms")
  minDurationMs Int?     @map("min_duration_ms")
  maxDurationMs Int?     @map("max_duration_ms")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  check Check @relation(fields: [checkId], references: [id], onDelete: Cascade)

  @@unique([checkId, windowStart])
  @@index([checkId])
  @@map("check_duration_stats")
}

model Channel {
  id        String      @id @default(dbgenerated("nanoid(16)"))
  projectId String      @map("project_id")
  type      ChannelType
  name      String
  config    Json
  isDefault Boolean     @default(false) @map("is_default")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  checkChannels CheckChannel[]

  @@map("channels")
}

model CheckChannel {
  checkId   String @map("check_id")
  channelId String @map("channel_id")

  check   Check   @relation(fields: [checkId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@id([checkId, channelId])
  @@map("check_channels")
}

model Alert {
  id        String   @id @default(dbgenerated("nanoid(16)"))
  checkId   String   @map("check_id")
  event     String
  channels  Json
  context   Json?
  success   Boolean
  error     String?
  createdAt DateTime @default(now()) @map("created_at")

  check Check @relation(fields: [checkId], references: [id], onDelete: Cascade)

  @@index([checkId, createdAt(sort: Desc)])
  @@map("alerts")
}

model ApiKey {
  id         String    @id @default(dbgenerated("nanoid(16)"))
  projectId  String    @map("project_id")
  name       String
  keyHash    String    @unique @map("key_hash")
  keyPrefix  String    @map("key_prefix")
  lastUsedAt DateTime? @map("last_used_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

enum CheckStatus {
  NEW
  UP
  LATE
  DOWN
  PAUSED

  @@map("check_status")
}

enum PingType {
  SUCCESS
  START
  FAIL

  @@map("ping_type")
}

enum ScheduleType {
  PERIOD
  CRON

  @@map("schedule_type")
}

enum ChannelType {
  EMAIL
  SLACK_WEBHOOK
  SLACK_APP
  DISCORD
  PAGERDUTY
  OPSGENIE
  WEBHOOK

  @@map("channel_type")
}

enum AnomalySensitivity {
  LOW
  NORMAL
  HIGH

  @@map("anomaly_sensitivity")
}

